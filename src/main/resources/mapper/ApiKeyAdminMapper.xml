<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gocle.lxp.mapper.ApiKeyAdminMapper">

    <insert id="insertApiKey">
    <![CDATA[
        INSERT INTO lxp_api_key (
            client_id,
            api_key,
            allowed_domains,
            enabled,
            rate_limit_per_min,
            expires_at,
            created_at
        ) VALUES (
            #{clientId},
            #{apiKey},
            #{allowedDomains},
            TRUE,
            #{rateLimitPerMin},
            #{expiresAt},
            NOW()
        )
    ]]>
    </insert>

    <update id="disableApiKey">
    <![CDATA[
        UPDATE lxp_api_key
        SET enabled = FALSE
        WHERE api_key_id = #{apiKeyId}
    ]]>
    </update>
    
    <!-- API Key 목록 조회 (마스킹용) -->
    <select id="selectApiKeyList" resultType="com.gocle.lxp.dto.apikey.ApiKeyListResponse">

        SELECT
            k.api_key_id          AS apiKeyId,
            k.api_key             AS maskedApiKey,
            k.client_id           AS clientId,
            k.enabled             AS enabled,
            k.rate_limit_per_min  AS rateLimitPerMin,
            k.expires_at          AS expiresAt,
            k.created_at          AS createdAt,

            c.client_code         AS clientCode,
            c.client_name         AS clientName
        FROM lxp_api_key k
        JOIN lxp_api_client c
          ON k.client_id = c.client_id
        ORDER BY k.created_at DESC
    </select>
    
     <!-- 재발급용 기존 설정 조회 -->
    <select id="selectForRotate" parameterType="long" resultType="com.gocle.lxp.dto.apikey.ApiKeyRotateSource">
        SELECT
            client_id        AS clientId,
            allowed_domains  AS allowedDomains,
            rate_limit_per_min AS rateLimitPerMin,
            expires_at       AS expiresAt
        FROM lxp_api_key
        WHERE api_key_id = #{apiKeyId}
          AND enabled = TRUE
    </select>
    
    <select id="selectApiKeysByClient" resultType="com.gocle.lxp.dto.apikey.ApiKeyListResponse">
	<![CDATA[
	    SELECT
	        api_key_id AS apiKeyId,
	        api_key    AS maskedApiKey,
	        enabled,
	        rate_limit_per_min AS rateLimitPerMin,
	        expires_at AS expiresAt,
	        created_at AS createdAt
	    FROM lxp_api_key
	    WHERE client_id = #{clientId}
	    ORDER BY api_key_id DESC
	]]>
	</select>

</mapper>
