<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gocle.lxp.mapper.InstitutionUserMapper">

    <!-- ê¸°ê´€ ì‚¬ìš©ìž ëª©ë¡ / ê²€ìƒ‰ (í†µí•©ê´€ë¦¬ìžìš©) -->
	<select id="selectInstitutionUsers"
	        resultType="com.gocle.lxp.dto.institution.InstitutionUserDto">
	
	<![CDATA[
	    SELECT
	        iu.institution_user_id AS institutionUserId,
	        iu.client_id           AS clientId,
	        c.client_name          AS clientName,
	        c.client_code          AS clientCode,
	        iu.login_id            AS loginId,
	        iu.user_name           AS userName,
	        iu.role,
	        iu.status,
	        iu.created_at          AS createdAt
	    FROM institution_user iu
	    JOIN lxp_api_client c
	      ON iu.client_id = c.client_id
	    WHERE 1 = 1
	]]>
	
	    <!-- ê¸°ê´€ ID ê²€ìƒ‰ -->
	    <if test="clientId != null">
	        <![CDATA[ AND iu.client_id = #{clientId} ]]>
	    </if>
	
	    <!-- ê¸°ê´€ëª… ê²€ìƒ‰ -->
	    <if test="clientName != null and clientName != ''">
	        <![CDATA[
	            AND c.client_name LIKE CONCAT('%', #{clientName}, '%')
	        ]]>
	    </if>
	
	    <!-- ë¡œê·¸ì¸ ID -->
	    <if test="loginId != null and loginId != ''">
	        <![CDATA[
	            AND iu.login_id LIKE CONCAT('%', #{loginId}, '%')
	        ]]>
	    </if>
	
	    <!-- ì‚¬ìš©ìž ì´ë¦„ -->
	    <if test="userName != null and userName != ''">
	        <![CDATA[
	            AND iu.user_name LIKE CONCAT('%', #{userName}, '%')
	        ]]>
	    </if>
	
	    <!-- ìƒíƒœ -->
	    <if test="status != null and status != ''">
	        <![CDATA[
	            AND iu.status = #{status}
	        ]]>
	    </if>
	
	<![CDATA[
	    ORDER BY c.client_name ASC, iu.created_at DESC
	]]>
	
	</select>


    <!-- ë‹¨ê±´ -->
    <select id="selectById"
            resultType="com.gocle.lxp.dto.institution.InstitutionUserDto">
    <![CDATA[
        SELECT
            institution_user_id AS institutionUserId,
            client_id           AS clientId,
            login_id            AS loginId,
            user_name           AS userName,
            role,
            status
        FROM institution_user
        WHERE institution_user_id = #{institutionUserId}
    ]]>
    </select>

    <!-- ì¤‘ë³µ ì²´í¬ -->
    <select id="existsByClientIdAndLoginId" resultType="int">
    <![CDATA[
        SELECT COUNT(1)
        FROM institution_user
        WHERE client_id = #{clientId}
          AND login_id = #{loginId}
    ]]>
    </select>

    <!-- ë“±ë¡ -->
    <insert id="insertInstitutionUser">
    <![CDATA[
        INSERT INTO institution_user (
            client_id, login_id, user_name, password, role, status
        ) VALUES (
            #{clientId}, #{loginId}, #{userName},
            #{password}, #{role}, #{status}
        )
    ]]>
    </insert>

    <!-- ìˆ˜ì • -->
    <update id="updateInstitutionUser">
    <![CDATA[
        UPDATE institution_user
        SET user_name = #{userName},
            status    = #{status}
        WHERE institution_user_id = #{institutionUserId}
    ]]>
    </update>

    <!-- ìƒíƒœ ë³€ê²½ -->
    <update id="updateStatus">
    <![CDATA[
        UPDATE institution_user
        SET status = #{status}
        WHERE institution_user_id = #{institutionUserId}
    ]]>
    </update>

    <!-- ì‚¬ìš©ìžëª… ìˆ˜ì • -->
	<update id="updateUserName">
	<![CDATA[
	    UPDATE institution_user
	       SET user_name = #{userName},
	           updated_at = NOW()
	     WHERE institution_user_id = #{institutionUserId}
	]]>
	</update>
	
	<!-- ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” -->
	<update id="updatePassword">
	<![CDATA[
	    UPDATE institution_user
	       SET password = #{password},
	           updated_at = NOW()
	     WHERE institution_user_id = #{institutionUserId}
	]]>
	</update>
	
	<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
	<update id="changePassword">
	<![CDATA[
	    UPDATE institution_user
	       SET password = #{password},
	           updated_at = NOW()
	     WHERE institution_user_id = #{institutionUserId}
	]]>
	</update>

    <!-- ì‚­ì œ -->
    <delete id="deleteById">
    <![CDATA[
        DELETE FROM institution_user
        WHERE institution_user_id = #{institutionUserId}
    ]]>
    </delete>
    
    <!-- ê¸°ê´€ë‹´ë‹¹ìž ë¡œê·¸ì¸ -->
    <select id="selectForLogin"  parameterType="map"  resultType="com.gocle.lxp.domain.InstitutionUser">
	<![CDATA[
	    SELECT
	        institution_user_id,
	        client_id,
	        login_id,
	        user_name,
	        password,
	        role,
	        status
	    FROM institution_user
	    WHERE client_id = #{clientId}
	      AND login_id = #{loginId}
	      AND status = 'ACTIVE'
	]]>
	</select>
	
	<!-- ðŸ” ê¸°ê´€ê´€ë¦¬ìž ë¡œê·¸ì¸ -->
	<select id="findByLoginId"  parameterType="string" resultType="com.gocle.lxp.domain.InstitutionUser">
	<![CDATA[
	    SELECT
	        institution_user_id AS institutionUserId,
	        client_id           AS clientId,
	        login_id            AS loginId,
	        user_name           AS userName,
	        password,
	        role,
	        status
	    FROM institution_user
	    WHERE login_id = #{loginId}
	      AND status = 'ACTIVE'
	]]>
	</select>

</mapper>
